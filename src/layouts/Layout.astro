---
import '../styles/global.css';
import Header from '../components/Header.astro';

interface Props {
  title?: string;
  description?: string;
}

const { 
  title = "AISAC Pixel â€” Digital Design Agency",
  description = "We provide full cycle web development and design services."
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    
    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
  </head>
  <body>
    <div id="app">
      <!-- SVG Symbols Vault -->
      <div class="vault">
        <svg xmlns="http://www.w3.org/2000/svg" style="display:none;">
          <symbol id="focus-arrow" viewBox="0 0 384 384">
            <path d="M272,176v153.4L111.8,169.2c-12.1-12.1-18.7-28.2-18.7-45.3s6.7-33.2,18.7-45.3c5.9-5.9,12.9-10.6,20.6-13.8l81.7-34.1-12.3-29.5-81.7,34.1c-11.6,4.8-22,11.8-31,20.7-18.1,18.1-28.1,42.2-28.1,67.9s10,49.8,28.1,67.9l160.2,160.2H96v32h192l16-16v-192h-32Z"></path>
          </symbol>
          <symbol id="logo-96x76" viewBox="0 0 96 76">
            <path d="M94.5,37.5c-0.3-8.9-7.5-16-16.5-16c-2.3,0-4.4,0.5-6.4,1.3C71.2,22.3,70.7,22,70,22c-1.1,0-2,0.9-2,2 c0,0.3,0.1,0.5,0.2,0.8c-1.9,1.4-3.5,3.2-4.7,5.3V0h-1v31c-0.9-1.5-2.2-2.8-3.6-3.9c0.1-0.2,0.1-0.4,0.1-0.6c0-1.1-0.9-2-2-2 c-0.6,0-1.2,0.3-1.6,0.8c-1.4-0.5-2.9-0.8-4.4-0.8c-7.3,0-13.2,5.8-13.5,13H0v1h37.5c0.3,7.2,6.2,13,13.5,13c1.6,0,3-0.3,4.4-0.8 c0.4,0.5,0.9,0.8,1.6,0.8c1.1,0,2-0.9,2-2c0-0.2,0-0.4-0.1-0.6c1.4-1,2.7-2.4,3.6-3.9v31h1V45.9c1.1,2.1,2.8,3.9,4.7,5.3 C68.1,51.5,68,51.7,68,52c0,1.1,0.9,2,2,2c0.7,0,1.2-0.3,1.6-0.8c2,0.8,4.1,1.3,6.4,1.3c8.9,0,16.2-7.1,16.5-16H96v-1H94.5z M51,48.5c-5.6,0-10.2-4.4-10.5-10h20.9C61.2,44.1,56.6,48.5,51,48.5z M40.5,37.5c0.3-5.6,4.9-10,10.5-10c5.6,0,10.2,4.4,10.5,10 H40.5z M78,51.5c-7.3,0-13.2-5.8-13.5-13h26.9C91.2,45.7,85.3,51.5,78,51.5z M64.5,37.5c0.3-7.2,6.2-13,13.5-13s13.2,5.8,13.5,13 H64.5z M3,35c1.7,0,3-1.3,3-3s-1.3-3-3-3c-1.7,0-3,1.3-3,3S1.3,35,3,35z M9,41c-1.1,0-2,0.9-2,2s0.9,2,2,2s2-0.9,2-2S10.1,41,9,41z"></path>
          </symbol>
          <symbol id="icon-24_aesthetics" viewBox="0 0 24 24">
            <path d="M12,4C7.6,4,3.6,6.5.2,11.4v1.2c3.5,4.9,7.4,7.4,11.8,7.4s8.4-2.5,11.8-7.4v-1.2c-3.5-4.9-7.4-7.4-11.8-7.4ZM12,18c-3.5,0-6.8-2-9.8-6,3-4,6.2-6,9.8-6s6.8,2,9.8,6c-3,4-6.2,6-9.8,6ZM14.1,9.9c-1.1-1.1-1.9-2.2-2.1-2.9-.3.7-1,1.8-2.1,2.9s-2.2,1.9-2.9,2.1c.7.3,1.8,1,2.9,2.1s1.9,2.2,2.1,2.9c.3-.7,1-1.8,2.1-2.9s2.2-1.9,2.9-2.1h0c-.7-.3-1.8-1.1-2.8-2.1ZM3,18.2c0,.7-.4,1.4-.9,1.9l-.2.2c-.4.4-.9.6-1.5.7h-.2s0,0,0,0c.7,0,1.4.4,1.9.9.5.5.8,1.2.9,1.9,0-.7.4-1.4.9-1.9s1.1-.8,1.7-.9h.2s0,0,0,0c-.7,0-1.4-.4-1.9-.9s-.8-1.2-.9-1.9ZM21.9,2.1c-.5-.5-.8-1.2-.9-1.9,0,.7-.4,1.4-.9,1.9l-.2.2c-.4.4-.9.6-1.5.7h-.2s0,0,0,0c.7,0,1.4.4,1.9.9.5.5.8,1.2.9,1.9,0-.7.4-1.4.9-1.9s1.1-.8,1.7-.9h.2s0,0,0,0c-.7,0-1.4-.4-1.9-.9Z"></path>
          </symbol>
          <symbol id="icon-24_dev" viewBox="0 0 24 24">
            <path d="M22,5.6L12.5.1h-1L2,5.6l-.5.9v11l.5.9,9.5,5.5h1l9.5-5.5.5-.9V6.5l-.5-.9ZM20.5,16.9l-8.5,4.9-8.5-4.9V7.1L12,2.2l8.5,4.9v9.8ZM7,12c0,2.8,2.2,5,5,5s5-2.2,5-5-2.2-5-5-5-5,2.2-5,5ZM15,12c0,1.7-1.3,3-3,3s-3-1.3-3-3,1.3-3,3-3,3,1.3,3,3Z"></path>
          </symbol>
          <symbol id="icon-24_enter" viewBox="0 0 24 24">
            <path d="M20,2h-5.5v2H20c1.1,0,2,0.9,2,2v5c0,1.1-0.9,2-2,2H3.4l6.3-6.3L8.3,5.3l-8,8v1.4l8,8l1.4-1.4L3.4,15H20c2.2,0,4-1.8,4-4V6 C24,3.8,22.2,2,20,2z"></path>
          </symbol>
          <symbol id="icon-24_blank" viewBox="0 0 24 24">
            <path d="M23,5H11v2h9.6l-10,10c-1.6,1.6-4.1,1.6-5.7,0c-0.4-0.4-0.7-0.8-0.9-1.3l-2.1-5.1l-1.8,0.8l2.1,5.1c0.3,0.7,0.7,1.4,1.3,1.9 c1.2,1.2,2.7,1.8,4.2,1.8s3.1-0.6,4.2-1.8l10-10V18h2V6L23,5z"></path>
          </symbol>
          <symbol id="icon-24_fiddle" viewBox="0 0 24 24">
            <path d="M14.5,2c0.6,0,1-0.4,1-1s-0.4-1-1-1s-1,0.4-1,1S13.9,2,14.5,2z M9.8,3.5c0.4,0,0.8-0.3,0.8-0.8S10.2,2,9.8,2 S9,2.3,9,2.8S9.3,3.5,9.8,3.5z M21.5,15.2h-6.7c0.6-0.7,1-1.5,1-2.5c0-1.9-1.4-3.5-3.2-3.7V0h-1v9.1c-1.8,0.2-3.2,1.8-3.2,3.7 c0,1,0.4,1.8,1,2.5H2.5v1h6.4c-0.9,0.8-1.4,2-1.4,3.2c0,2.5,2,4.5,4.5,4.5s4.5-2,4.5-4.5c0-1.3-0.5-2.4-1.4-3.2h6.4V15.2z M11.5,22.4C10.1,22.2,9,21,9,19.5s1.1-2.7,2.5-2.9V22.4z M11.5,14.9c-1-0.2-1.8-1.1-1.8-2.2c0-1.1,0.8-2,1.8-2.2V14.9z M12.5,10.6 c1,0.2,1.8,1.1,1.8,2.2c0,1.1-0.8,2-1.8,2.2V10.6z M12.5,22.4v-5.9c1.4,0.2,2.5,1.5,2.5,2.9S13.9,22.2,12.5,22.4z"></path>
          </symbol>
          <symbol id="icon-24_arrow" viewBox="0 0 24 24">
            <polygon points="22.3 11.3 13 20.6 13 1 11 1 11 20.6 1.7 11.3 .3 12.7 11.3 23.7 12.7 23.7 23.7 12.7 22.3 11.3"></polygon>
          </symbol>
        </svg>
      </div>

      <!-- Main Content -->
      <main class="page home-page">
        <slot />
      </main>

      <!-- Header (sticky) -->
      <Header />
    </div>

    <script>
      // Set viewport height CSS variable for mobile
      function setVH() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      }
      
      setVH();
      window.addEventListener('resize', setVH);

      // Lenis Smooth Scroll - Optimized Configuration
      import Lenis from 'lenis';

      // Initialize Lenis with optimized settings
      const lenis = new Lenis({
        duration: 1.2,           // Duration of the scroll animation (seconds)
        easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)), // Easing function (easeOutExpo)
        orientation: 'vertical', // Scroll direction
        gestureOrientation: 'vertical',
        smoothWheel: true,       // Enable smooth scrolling for mouse wheel
        wheelMultiplier: 1,      // Wheel scroll speed multiplier
        touchMultiplier: 2,      // Touch scroll speed multiplier
        infinite: false,         // Infinite scroll
        autoResize: true,        // Auto resize on window resize
      });

      // Optimized animation loop using requestAnimationFrame
      function raf(time: number) {
        lenis.raf(time);
        requestAnimationFrame(raf);
      }

      // Start the animation loop
      requestAnimationFrame(raf);

      // Expose lenis to window for external access (useful for scroll-based animations)
      (window as any).lenis = lenis;

      // Add class to html when scroll is ready
      document.documentElement.classList.add('lenis-ready');

      // Handle anchor links smoothly
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', (e) => {
          e.preventDefault();
          const href = anchor.getAttribute('href');
          if (href) {
            const target = document.querySelector(href) as HTMLElement | null;
            if (target) {
              lenis.scrollTo(target);
            }
          }
        });
      });

      // ========================================
      // SCROLL-BASED ANIMATIONS
      // ========================================
      
      // Elements (cast to HTMLElement for TypeScript)
      const header = document.querySelector('.header') as HTMLElement | null;
      const logoSection = document.querySelector('.logo-section') as HTMLElement | null;
      const navSection = document.querySelector('.nav-section') as HTMLElement | null;
      const welcomeSection = document.querySelector('.c-welcome') as HTMLElement | null;
      const mediaHolder = document.querySelector('.c-welcome .media-holder') as HTMLElement | null;
      const mediaWrap = document.querySelector('.c-welcome .media-wrap') as HTMLElement | null;
      
      // Threshold: when header should transform (in pixels from top)
      const SCROLL_THRESHOLD = 100;
      
      // ========================================
      // VIDEO STICKY SIMULATION
      // We manually control the position with JavaScript
      // This avoids issues with Lenis and position: sticky
      // ========================================
      let videoInitialTop = 0;       // Distance from document top to video
      let videoStickyPoint = 0;      // Viewport position where video should "stick"
      let videoOriginalWidth = 0;    // Original width for fixed positioning
      let videoOriginalLeft = 0;     // Original left for fixed positioning
      let isVideoFixed = false;
      
      const initVideoPosition = () => {
        if (!mediaHolder || !mediaWrap) return;
        
        // Remove fixed class first to get accurate measurements
        mediaHolder.classList.remove('-fixed');
        
        // Get the video's position relative to the document
        const rect = mediaHolder.getBoundingClientRect();
        const scrollY = window.scrollY;
        
        videoInitialTop = rect.top + scrollY;  // Position from document top
        videoStickyPoint = rect.top;           // Initial viewport position = sticky point
        videoOriginalWidth = rect.width;
        videoOriginalLeft = rect.left;
        
        console.log('Video init:', {
          initialTop: videoInitialTop,
          stickyPoint: videoStickyPoint,
          width: videoOriginalWidth,
          left: videoOriginalLeft
        });
      };
      
      // Initialize on load
      initVideoPosition();
      
      // Recalculate on resize
      window.addEventListener('resize', () => {
        if (!isVideoFixed) {
          initVideoPosition();
        }
      });
      
      // Track scroll state
      let isScrolled = false;
      let lastScrollY = 0;
      
      // Update scroll-based animations
      function updateScrollAnimations() {
        const scrollY = lenis.scroll || window.scrollY;
        
        // ========================================
        // 1. HEADER TRANSFORMATION
        // When scrolled past threshold, header goes to "hold" state
        // ========================================
        if (scrollY > SCROLL_THRESHOLD && !isScrolled) {
          isScrolled = true;
          document.documentElement.classList.add('-scrolled');
          header?.classList.add('-hold');
          logoSection?.classList.add('-minimized');
          navSection?.classList.add('-hold');
        } else if (scrollY <= SCROLL_THRESHOLD && isScrolled) {
          isScrolled = false;
          document.documentElement.classList.remove('-scrolled');
          header?.classList.remove('-hold');
          logoSection?.classList.remove('-minimized');
          navSection?.classList.remove('-hold');
        }
        
        // ========================================
        // 2. VIDEO STICKY SIMULATION + CLOSING EFFECT
        // Manually control position to avoid Lenis conflicts
        // ========================================
        if (welcomeSection && mediaHolder && mediaWrap && videoStickyPoint > 0) {
          // Calculate where the video WOULD be without fixing
          const whereVideoWouldBe = videoInitialTop - scrollY;
          
          // Get original height based on aspect ratio
          const mediaWidth = videoOriginalWidth || mediaHolder.offsetWidth;
          const aspectRatio = window.innerWidth >= 1024 ? (12/21) : (9/16);
          const originalHeight = mediaWidth * aspectRatio;
          
          // Store original height
          if (!mediaHolder.dataset.originalHeight) {
            mediaHolder.dataset.originalHeight = originalHeight.toString();
          }
          const storedHeight = parseFloat(mediaHolder.dataset.originalHeight);
          
          // Should the video be fixed?
          // Yes, if it would scroll above its sticky point
          const shouldBeFixed = whereVideoWouldBe < videoStickyPoint;
          
          if (shouldBeFixed && !isVideoFixed) {
            // Switch to fixed positioning
            isVideoFixed = true;
            mediaHolder.classList.add('-fixed');
            mediaHolder.style.top = `${videoStickyPoint}px`;
            mediaHolder.style.left = `${videoOriginalLeft}px`;
            mediaHolder.style.width = `${videoOriginalWidth}px`;
            
            // Add placeholder height to parent to maintain layout
            mediaWrap.style.minHeight = `${storedHeight}px`;
          } else if (!shouldBeFixed && isVideoFixed) {
            // Switch back to relative positioning
            isVideoFixed = false;
            mediaHolder.classList.remove('-fixed');
            mediaHolder.style.top = '';
            mediaHolder.style.left = '';
            mediaHolder.style.width = '';
            mediaWrap.style.minHeight = '';
          }
          
          // Calculate closing progress
          let progress = 0;
          
          if (shouldBeFixed) {
            // How much have we scrolled past the trigger point?
            const distancePastTrigger = videoStickyPoint - whereVideoWouldBe;
            progress = distancePastTrigger / storedHeight;
          }
          
          // Clamp progress between 0 and 1
          progress = Math.max(0, Math.min(1, progress));
          
          // Calculate new height based on progress
          const newHeight = storedHeight * (1 - progress);
          
          // Apply the height
          mediaHolder.style.maxHeight = `${newHeight}px`;
          mediaHolder.style.setProperty('--progress', progress.toFixed(4));
        }
        
        lastScrollY = scrollY;
      }
      
      // Listen to Lenis scroll events
      lenis.on('scroll', updateScrollAnimations);
      
      // Initial call
      updateScrollAnimations();
      
      // ========================================
      // 3. NAVBAR HOVER EFFECT
      // When in -hold state, hovering navbar shows container
      // ========================================
      if (navSection) {
        navSection.addEventListener('mouseenter', () => {
          if (navSection.classList.contains('-hold')) {
            navSection.classList.add('-hovered');
          }
        });
        
        navSection.addEventListener('mouseleave', () => {
          navSection.classList.remove('-hovered');
        });
      }
      
      // Mark as ready for animations
      setTimeout(() => {
        document.documentElement.classList.add('-ready', '-loaded');
      }, 100);
    </script>
  </body>
</html>

<style>
  #app {
    background-color: var(--c-berry);
    min-height: 100vh;
    min-height: calc(var(--vh, 1vh) * 100);
  }

  .home-page {
    background-color: var(--c-berry);
  }
</style>
