---
// GlassButton.astro - Glassmorphism button with spotlight effect
// Optimized for performance and scalability

interface Props {
    href?: string;
    label: string;
    class?: string;
}

const { href = "#", label, class: className = "" } = Astro.props;
---

<a href={href} class:list={["glass-button", className]}>
    <span class="glass-button-inner"></span>
    <span class="glass-button-label">{label}</span>
</a>

<style>
    .glass-button {
        /* Configuración base */
        --glass-radius: 9999px;
        --glass-bg: hsla(240, 8%, 68%, 0.05);
        --bounce-easing: cubic-bezier(0.34, 1.56, 0.64, 1);

        /* Variables para el Spotlight (se llenan con JS) */
        --mouse-x: 50%;
        --mouse-y: 50%;

        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        cursor: pointer;
        padding: 0.15rem 2.4rem;

        /* GPU acceleration - evita parpadeos */
        transform: translateZ(0);
        will-change: auto;
    }

    /* --- 1. EL TEXTO --- */
    .glass-button-label {
        position: relative;
        z-index: 10;
        color: #101214;
        font-family: var(--font, system-ui, sans-serif);
        font-size: 20px;
        font-weight: 500;
        letter-spacing: 0.02em;
        pointer-events: none;
    }

    /* --- 2. LA CÁPSULA (Fondo y Borde) --- */
    .glass-button-inner {
        position: absolute;
        inset: 0;
        border-radius: var(--glass-radius);
        background-color: var(--glass-bg);

        /* Efecto Cristal */
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);

        /* Sombras para volumen */
        box-shadow:
            inset 0 1px 1px rgba(255, 255, 255, 0.4),
            inset 0 -2px 10px rgba(255, 255, 255, 0.3),
            0 8px 20px -5px rgba(0, 0, 0, 0.1);

        /* Estado inicial - animación de salida elástica */
        animation: jelly-shrink 0.6s ease forwards;
    }

    /* --- EFECTO HOVER (Expansión suave) --- */
    .glass-button:hover .glass-button-inner {
        animation: smooth-expand 0.4s ease forwards;
        box-shadow:
            inset 0 1px 1px rgba(255, 255, 255, 0.4),
            inset 0 -2px 10px rgba(255, 255, 255, 0.5),
            0 2px 10px -2px rgba(0, 0, 0, 0.1);
    }

    /* Animación de entrada - se expande con efecto "bulge" 3D */
    @keyframes smooth-expand {
        0% {
            transform: perspective(200px) scale(1, 1) rotateX(0deg)
                translateZ(0);
        }
        50% {
            transform: perspective(200px) scale(1.04, 1.1) rotateX(3deg)
                translateZ(8px);
        }
        100% {
            transform: perspective(200px) scale(1.03, 1.08) rotateX(2deg)
                translateZ(5px);
        }
    }

    /* Animación de salida - se encoge con elasticidad */
    @keyframes jelly-shrink {
        0% {
            transform: scale(1.05, 1.04);
        }
        20% {
            transform: scale(0.94, 1.06);
        }
        40% {
            transform: scale(1.03, 0.97);
        }
        60% {
            transform: scale(0.98, 1.02);
        }
        80% {
            transform: scale(1.01, 0.99);
        }
        100% {
            transform: scale(1, 1);
        }
    }

    /* --- 3. EL SPOTLIGHT Y BORDE --- */
    .glass-button-inner::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        padding: 1px;
        pointer-events: none;
        opacity: 0.8;

        /* COMBINACIÓN DE LUCES */
        background: 
            /* Spotlight que sigue al mouse */
            radial-gradient(
                120px circle at var(--mouse-x) var(--mouse-y),
                rgba(255, 255, 255, 1),
                transparent 100%
            ),
            /* Luz cenital estática */
            linear-gradient(
                    to bottom,
                    rgba(255, 255, 255, 0.6) 0%,
                    rgba(255, 255, 255, 0) 40%,
                    rgba(255, 255, 255, 0.1) 100%
                );

        /* Máscara técnica para dejar solo el borde */
        -webkit-mask:
            linear-gradient(#fff 0 0) content-box,
            linear-gradient(#fff 0 0);
        mask:
            linear-gradient(#fff 0 0) content-box,
            linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
    }
</style>

<script>
    // Throttle helper - limita ejecución a 1 vez cada 16ms (~60fps)
    function throttle<T extends (...args: any[]) => void>(
        fn: T,
        ms: number,
    ): T {
        let lastCall = 0;
        return ((...args: any[]) => {
            const now = Date.now();
            if (now - lastCall >= ms) {
                lastCall = now;
                fn(...args);
            }
        }) as T;
    }

    // Map para rastrear controllers por elemento (evita duplicados)
    const controllerMap = new WeakMap<Element, AbortController>();

    function initSpotlights() {
        const buttons = document.querySelectorAll<HTMLElement>(".glass-button");

        buttons.forEach((btn) => {
            // Limpiar listener anterior si existe (evita memory leaks)
            const existingController = controllerMap.get(btn);
            if (existingController) {
                existingController.abort();
            }

            // Nuevo controller para este elemento
            const controller = new AbortController();
            controllerMap.set(btn, controller);

            // Handler con throttle para rendimiento
            const handleMouseMove = throttle((e: MouseEvent) => {
                const rect = btn.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                btn.style.setProperty("--mouse-x", `${x}px`);
                btn.style.setProperty("--mouse-y", `${y}px`);
            }, 16); // ~60fps

            btn.addEventListener("mousemove", handleMouseMove, {
                signal: controller.signal,
                passive: true,
            });
        });
    }

    // Ejecutar al cargar y al navegar (View Transitions)
    initSpotlights();
    document.addEventListener("astro:page-load", initSpotlights);
</script>
